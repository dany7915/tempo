From 10a4cde203ed31cc92198a50a5678c9763a1843e Mon Sep 17 00:00:00 2001
From: Daniel <dany7915@gmail.com>
Date: Fri, 28 Jun 2024 10:11:51 +0000
Subject: [PATCH] smooth

---
 selfdrive/car/hyundai/carcontroller.py                  | 2 +-
 selfdrive/car/hyundai/interface.py                      | 4 +++-
 selfdrive/controls/lib/longitudinal_mpc_lib/long_mpc.py | 2 +-
 selfdrive/controls/lib/longitudinal_planner.py          | 5 ++++-
 4 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/selfdrive/car/hyundai/carcontroller.py b/selfdrive/car/hyundai/carcontroller.py
index f640f6529a..d4e600ceea 100644
--- a/selfdrive/car/hyundai/carcontroller.py
+++ b/selfdrive/car/hyundai/carcontroller.py
@@ -284,7 +284,7 @@ def update(self, CC, CS, now_nanos):
           stopping = stopping and CS.out.vEgoRaw < 0.05
 
         # TODO: unclear if this is needed
-        jerk = 3.0 if actuators.longControlState == LongCtrlState.pid else 1.0
+        jerk = 1.5 if actuators.longControlState == LongCtrlState.pid else 1.0
         use_fca = self.CP.flags & HyundaiFlags.USE_FCA.value
         can_sends.extend(hyundaican.create_acc_commands(self.packer, CC.enabled and CS.out.cruiseState.enabled, accel, jerk, int(self.frame / 2),
                                                         hud_control, set_speed_in_units, stopping,
diff --git a/selfdrive/car/hyundai/interface.py b/selfdrive/car/hyundai/interface.py
index e801b47771..392f1bccf8 100644
--- a/selfdrive/car/hyundai/interface.py
+++ b/selfdrive/car/hyundai/interface.py
@@ -178,7 +178,9 @@ def _get_params(ret, candidate, fingerprint, car_fw, experimental_long, docs):
       ret.minSteerSpeed = 0.
 
     if Params().get_bool("HkgSmoothStop"):
-      ret.vEgoStopping = 0.1
+      ret.vEgoStopping = 0.05
+      ret.stoppingDecelRate = 0.05
+      ret.startAccel = 0.
 
     return ret
 
diff --git a/selfdrive/controls/lib/longitudinal_mpc_lib/long_mpc.py b/selfdrive/controls/lib/longitudinal_mpc_lib/long_mpc.py
index cba398bcca..5aaa86467b 100755
--- a/selfdrive/controls/lib/longitudinal_mpc_lib/long_mpc.py
+++ b/selfdrive/controls/lib/longitudinal_mpc_lib/long_mpc.py
@@ -40,7 +40,7 @@
 A_CHANGE_COST = 200.
 DANGER_ZONE_COST = 100.
 CRASH_DISTANCE = .25
-LEAD_DANGER_FACTOR = 0.75
+LEAD_DANGER_FACTOR = 0.85
 LIMIT_COST = 1e6
 ACADOS_SOLVER_TYPE = 'SQP_RTI'
 
diff --git a/selfdrive/controls/lib/longitudinal_planner.py b/selfdrive/controls/lib/longitudinal_planner.py
index 9f508fb76b..72e925d7b0 100755
--- a/selfdrive/controls/lib/longitudinal_planner.py
+++ b/selfdrive/controls/lib/longitudinal_planner.py
@@ -133,8 +133,11 @@ def update(self, sm):
       self.mpc.mode = 'blended' if sm['controlsState'].experimentalMode else 'acc'
 
     v_ego = sm['carState'].vEgo
+    v_ego_raw = sm['carState'].vEgoRaw
+    v_ego_cluster = sm['carState'].vEgoCluster
+    v_ego_diff = v_ego_raw - v_ego_cluster if v_ego_cluster > 0 else 0
     v_cruise_kph = min(sm['controlsState'].vCruise, V_CRUISE_MAX)
-    v_cruise = v_cruise_kph * CV.KPH_TO_MS
+    v_cruise = v_cruise_kph * CV.KPH_TO_MS + v_ego_diff
 
     long_control_off = sm['controlsState'].longControlState == LongCtrlState.off
     force_slow_decel = sm['controlsState'].forceDecel